  name: Node.js CI

  on:
    push:
      branches:
        - develop
        - main
        - release

  jobs:
    build:
      runs-on: ubuntu-latest

      strategy:
        matrix:
          node-version: [20.x]

      steps:
      - uses: actions/checkout@v2
      - name: Install Backend dependencies
        if: github.ref == 'refs/heads/release'
        working-directory: ./backend/src
        run: npm install

      - name: Testes de integração
        if: github.ref == 'refs/heads/release'
        working-directory: ./backend/src
        run: npm test

      - name: Install FrontDepedencies
        working-directory: ./frontend/src
        run: npm install

      - name: Testes unitários 
        working-directory: ./frontend/src
        run: npm test

      - name: SonarQube Scan
        if: github.ref == 'refs/heads/release'
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: sqp_667b9da7edb3cf4de01151d6611a13bb75cf21b6
        with:
          args: >
            -Dsonar.projectKey=a3-qualidade-de-software
            -Dsonar.sources=./backend/src,./frontend/src
            -Dsonar.host.url=https://f1ed-187-44-172-38.ngrok-free.app
            -Dsonar.login=$sqp_667b9da7edb3cf4de01151d6611a13bb75cf21b6